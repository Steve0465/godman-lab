<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Thread Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .upload-section {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px dashed #ddd;
        }
        
        .upload-section.drag-over {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .file-input-wrapper {
            margin-bottom: 15px;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        
        .settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .images-list {
            margin-top: 30px;
        }
        
        .image-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-card:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .image-card.processed {
            border-left: 4px solid #4CAF50;
        }
        
        .image-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .image-card .meta {
            color: #666;
            font-size: 14px;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .bubble-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .bubble-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .bubble-image {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .bubble-text {
            margin-bottom: 10px;
        }
        
        .bubble-text textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .confidence {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .confidence.high {
            color: #4CAF50;
        }
        
        .confidence.medium {
            color: #FF9800;
        }
        
        .confidence.low {
            color: #F44336;
        }
        
        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± OCR Thread Analyzer</h1>
        
        <div class="status" id="status"></div>
        
        <div class="upload-section" id="dropZone">
            <h2>Upload Screenshot</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept="image/*">
            </div>
            
            <div class="settings">
                <div>
                    <label for="presetSelect">Messaging UI Preset:</label>
                    <select id="presetSelect">
                        <option value="generic">Generic</option>
                        <option value="imessage">iMessage</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="android_sms">Android SMS</option>
                    </select>
                </div>
                
                <div>
                    <label for="ocrSelect">OCR Backend:</label>
                    <select id="ocrSelect">
                        <option value="tesseract">Tesseract (Local)</option>
                    </select>
                </div>
            </div>
            
            <button id="uploadBtn" onclick="uploadAndProcess()">Upload & Process</button>
        </div>
        
        <div class="images-list">
            <h2>Processed Images</h2>
            <div id="imagesList"></div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>OCR Results - <span id="currentImageName"></span></h2>
            <div class="action-buttons">
                <button onclick="saveAllCorrections()">üíæ Save All Corrections</button>
                <button onclick="exportThread()">üì§ Export Thread JSON</button>
            </div>
            <div class="bubble-container" id="bubblesContainer"></div>
        </div>
    </div>
    
    <script>
        let currentImageId = null;
        
        // Load available backends on startup
        async function loadBackends() {
            try {
                const response = await fetch('/api/backends');
                const data = await response.json();
                
                const select = document.getElementById('ocrSelect');
                select.innerHTML = '';
                
                data.backends.forEach(backend => {
                    const option = document.createElement('option');
                    option.value = backend.name;
                    option.textContent = backend.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading backends:', error);
            }
        }
        
        // Load images list
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const data = await response.json();
                
                const container = document.getElementById('imagesList');
                container.innerHTML = '';
                
                if (data.images.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No images uploaded yet</p>';
                    return;
                }
                
                data.images.forEach(image => {
                    const card = document.createElement('div');
                    card.className = 'image-card' + (image.processed ? ' processed' : '');
                    card.onclick = () => loadImageResults(image.id);
                    
                    // Create elements safely to avoid XSS
                    const title = document.createElement('h3');
                    title.textContent = image.filename;  // Safe text content
                    
                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    
                    const uploadedText = document.createTextNode(
                        `Uploaded: ${new Date(image.uploaded_at).toLocaleString()}`
                    );
                    meta.appendChild(uploadedText);
                    meta.appendChild(document.createElement('br'));
                    
                    const statusText = document.createTextNode(
                        `Status: ${image.processed ? '‚úÖ Processed' : '‚è≥ Pending'}`
                    );
                    meta.appendChild(statusText);
                    
                    card.appendChild(title);
                    card.appendChild(meta);
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading images:', error);
                showStatus('Error loading images', 'error');
            }
        }
        
        // Upload and process image
        async function uploadAndProcess() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Processing...';
            
            try {
                // Upload file
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                const imageId = uploadData.id;
                
                showStatus('File uploaded, processing...', 'success');
                
                // Process image
                const preset = document.getElementById('presetSelect').value;
                const ocrBackend = document.getElementById('ocrSelect').value;
                
                const processResponse = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_id: imageId,
                        preset: preset,
                        ocr_backend: ocrBackend
                    })
                });
                
                const processData = await processResponse.json();
                
                showStatus(`Processing complete! Found ${processData.num_bubbles} bubbles`, 'success');
                
                // Reload images and show results
                await loadImages();
                await loadImageResults(imageId);
                
                // Reset form
                fileInput.value = '';
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error processing image: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Process';
            }
        }
        
        // Load results for an image
        async function loadImageResults(imageId) {
            currentImageId = imageId;
            
            try {
                const response = await fetch(`/api/images/${imageId}`);
                const data = await response.json();
                
                document.getElementById('currentImageName').textContent = data.filename;
                document.getElementById('resultsSection').style.display = 'block';
                
                const container = document.getElementById('bubblesContainer');
                container.innerHTML = '';
                
                if (data.bubbles.length === 0) {
                    container.innerHTML = '<p>No bubbles detected</p>';
                    return;
                }
                
                data.bubbles.forEach(bubble => {
                    const card = document.createElement('div');
                    card.className = 'bubble-card';
                    
                    const text = bubble.corrected_text || bubble.original_text || '';
                    const confidence = bubble.confidence || 0;
                    const confidenceClass = confidence > 0.8 ? 'high' : confidence > 0.5 ? 'medium' : 'low';
                    
                    card.innerHTML = `
                        <img src="/api/bubbles/${imageId}/${bubble.index}" class="bubble-image" alt="Bubble ${bubble.index}">
                        <div class="bubble-text">
                            <label>Text (editable):</label>
                            <textarea id="text-${bubble.index}">${text}</textarea>
                        </div>
                        <div class="confidence ${confidenceClass}">
                            Confidence: ${(confidence * 100).toFixed(1)}%
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Scroll to results
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading results:', error);
                showStatus('Error loading results', 'error');
            }
        }
        
        // Save all corrections
        async function saveAllCorrections() {
            if (!currentImageId) return;
            
            try {
                const response = await fetch(`/api/images/${currentImageId}`);
                const data = await response.json();
                
                const promises = data.bubbles.map(async (bubble) => {
                    const textarea = document.getElementById(`text-${bubble.index}`);
                    if (textarea) {
                        const correctedText = textarea.value;
                        
                        return fetch('/api/corrections', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image_id: currentImageId,
                                bubble_index: bubble.index,
                                corrected_text: correctedText
                            })
                        });
                    }
                });
                
                await Promise.all(promises);
                showStatus('All corrections saved!', 'success');
                
            } catch (error) {
                console.error('Error saving corrections:', error);
                showStatus('Error saving corrections', 'error');
            }
        }
        
        // Export thread JSON
        async function exportThread() {
            if (!currentImageId) return;
            
            try {
                const response = await fetch(`/api/export/${currentImageId}`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `thread_${currentImageId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Thread exported!', 'success');
                
            } catch (error) {
                console.error('Error exporting thread:', error);
                showStatus('Error exporting thread', 'error');
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
            }
        });
        
        // Initialize
        loadBackends();
        loadImages();
    </script>
</body>
</html>
